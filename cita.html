<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Cita - Barbería Elegante</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="cita.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <header>
        <img src="https://thebiz.me/wp-content/uploads/2020/11/hair-salon-logo-ideas-6.24.22-PM.png" alt="Logo Barbería" class="header-logo">
        <div class="header-content">
            <h1>Barbería Elegante</h1>
            <nav>
                <ul>
                    <li><a href="index.html#inicio">Inicio</a></li>
                    <li><a href="index.html#servicios">Servicios</a></li>
                    <li><a href="index.html#nosotros">Nosotros</a></li>
                    <li><a href="index.html#contacto">Contacto</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section id="reserva">
        <div class="reserva-container">
            <h2 class="titulo-seccion">Reserva tu Cita</h2>
            <form class="formulario-cita" id="formularioCita">
                <div class="form-grupo">
                    <label for="nombre">Nombre Completo</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>

                <div class="form-grupo">
                    <label for="telefono">Teléfono</label>
                    <input type="tel" id="telefono" name="telefono" required>
                </div>

                <div class="form-grupo">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-grupo">
                    <label for="fecha">Fecha Deseada</label>
                    <input type="date" id="fecha" name="fecha" required>
                </div>

                <div class="form-grupo">
                    <label>Hora Preferida</label>
                    <div class="horas-container">
                        <div class="hora-item">
                            <input type="radio" id="hora-09-00" name="hora" value="09:00" required>
                            <label for="hora-09-00">09:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-09-30" name="hora" value="09:30">
                            <label for="hora-09-30">09:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-10-00" name="hora" value="10:00">
                            <label for="hora-10-00">10:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-10-30" name="hora" value="10:30">
                            <label for="hora-10-30">10:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-11-00" name="hora" value="11:00">
                            <label for="hora-11-00">11:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-11-30" name="hora" value="11:30">
                            <label for="hora-11-30">11:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-12-00" name="hora" value="12:00">
                            <label for="hora-12-00">12:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-12-30" name="hora" value="12:30">
                            <label for="hora-12-30">12:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-13-00" name="hora" value="13:00">
                            <label for="hora-13-00">13:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-13-30" name="hora" value="13:30">
                            <label for="hora-13-30">13:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-16-00" name="hora" value="16:00">
                            <label for="hora-16-00">16:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-16-30" name="hora" value="16:30">
                            <label for="hora-16-30">16:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-17-00" name="hora" value="17:00">
                            <label for="hora-17-00">17:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-17-30" name="hora" value="17:30">
                            <label for="hora-17-30">17:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-18-00" name="hora" value="18:00">
                            <label for="hora-18-00">18:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-18-30" name="hora" value="18:30">
                            <label for="hora-18-30">18:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-19-00" name="hora" value="19:00">
                            <label for="hora-19-00">19:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-19-30" name="hora" value="19:30">
                            <label for="hora-19-30">19:30</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-20-00" name="hora" value="20:00">
                            <label for="hora-20-00">20:00</label>
                        </div>
                        <div class="hora-item">
                            <input type="radio" id="hora-20-30" name="hora" value="20:30">
                            <label for="hora-20-30">20:30</label>
                        </div>
                    </div>
                </div>

                <div class="form-grupo">
                    <label for="servicio">Servicio</label>
                    <select id="servicio" name="servicio" required>
                        <option value="">Selecciona un servicio</option>
                        <option value="corte">Corte Clásico - 25€</option>
                        <option value="barba">Arreglo de Barba Premium - 20€</option>
                        <option value="afeitado">Afeitado Tradicional - 30€</option>
                        <option value="completo">Experiencia Completa - 45€</option>
                    </select>
                </div>

                <div class="form-grupo">
                    <label for="notas">Notas Adicionales</label>
                    <textarea id="notas" name="notas" rows="4"></textarea>
                </div>

                <button type="submit" class="boton-dorado">Reservar Cita</button>
            </form>
        </div>
    </section>

    <footer>
        <p>Contacto: info@barberia-elegante.com | Tel: 123-456-789</p>
        <p>Dirección: Calle Principal 123, Ciudad</p>
    </footer>

    <div class="notificacion" id="notificacion">
        <div class="notificacion-contenido">
            <i class="fas fa-check-circle"></i>
            <p id="mensaje-notificacion">¡Tu cita ha sido reservada con éxito!</p>
            <button class="boton-cerrar" onclick="cerrarNotificacion()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        const formulario = document.getElementById('formularioCita');
        const notificacion = document.getElementById('notificacion');
        const mensajeNotificacion = document.getElementById('mensaje-notificacion');
        const db = firebase.firestore();
        const fechaInput = document.getElementById('fecha');
        const horasContainer = document.querySelector('.horas-container');

        // Función para verificar horas ocupadas
        async function verificarHorasOcupadas(fecha) {
            try {
                console.log('Verificando horas para fecha:', fecha);
                const citasRef = db.collection('citas');
                const snapshot = await citasRef
                    .where('fecha', '==', fecha)
                    .get();
                
                const horasOcupadas = new Set();
                snapshot.forEach(doc => {
                    const cita = doc.data();
                    if (cita.estado !== 'cancelada') {
                        console.log('Cita encontrada:', cita);
                        horasOcupadas.add(cita.hora);
                    }
                });

                console.log('Horas ocupadas:', Array.from(horasOcupadas));

                // Habilitar/deshabilitar horas según disponibilidad
                const horasInputs = document.querySelectorAll('.hora-item input[type="radio"]');
                horasInputs.forEach(input => {
                    const horaLabel = input.nextElementSibling;
                    if (horasOcupadas.has(input.value)) {
                        console.log('Marcando hora como ocupada:', input.value);
                        input.disabled = true;
                        input.checked = false;
                        horaLabel.classList.add('ocupada');
                    } else {
                        input.disabled = false;
                        horaLabel.classList.remove('ocupada');
                    }
                });
            } catch (error) {
                console.error('Error al verificar horas ocupadas:', error);
            }
        }

        // Evento para cuando cambia la fecha
        fechaInput.addEventListener('change', function() {
            if (this.value) {
                verificarHorasOcupadas(this.value);
            }
        });

        formulario.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(formulario);
                const fecha = formData.get('fecha');
                const hora = formData.get('hora');
                const nombre = formData.get('nombre');
                const telefono = formData.get('telefono');
                const email = formData.get('email');
                const servicio = formData.get('servicio');

                console.log('Datos del formulario:', {
                    fecha,
                    hora,
                    nombre,
                    telefono,
                    email,
                    servicio
                });

                // Verificar que todos los campos requeridos estén completos
                if (!fecha || !hora || !nombre || !telefono || !email || !servicio) {
                    console.log('Campos faltantes:', {
                        fecha: !fecha,
                        hora: !hora,
                        nombre: !nombre,
                        telefono: !telefono,
                        email: !email,
                        servicio: !servicio
                    });
                    mostrarNotificacion('Por favor, complete todos los campos requeridos.');
                    return;
                }

                // Verificar nuevamente si la hora está disponible
                const citasRef = db.collection('citas');
                console.log('Verificando disponibilidad para:', { fecha, hora });
                
                const snapshot = await citasRef
                    .where('fecha', '==', fecha)
                    .where('hora', '==', hora)
                    .get();

                const citasActivas = snapshot.docs.filter(doc => doc.data().estado !== 'cancelada');
                console.log('Citas encontradas:', citasActivas.length);

                if (citasActivas.length > 0) {
                    mostrarNotificacion('Lo sentimos, esta hora ya ha sido reservada. Por favor, seleccione otra hora.');
                    verificarHorasOcupadas(fecha);
                    return;
                }

                // Crear el objeto de datos
                const datos = {
                    nombre: nombre,
                    telefono: telefono,
                    email: email,
                    fecha: fecha,
                    hora: hora,
                    servicio: servicio,
                    notas: formData.get('notas') || '',
                    estado: 'pendiente',
                    fecha_creacion: firebase.firestore.Timestamp.now()
                };

                console.log('Intentando guardar datos:', datos);

                // Guardar en Firebase
                const docRef = await db.collection('citas').add(datos);
                console.log('Cita guardada con ID:', docRef.id);
                
                mostrarNotificacion('¡Tu cita ha sido reservada con éxito!');
                formulario.reset();
                verificarHorasOcupadas(fecha);
            } catch (error) {
                console.error('Error completo:', error);
                mostrarNotificacion('Error al reservar la cita. Por favor, inténtalo de nuevo.');
            }
        });

        // Función para verificar si una hora específica está disponible
        async function verificarHoraDisponible(fecha, hora) {
            try {
                const citasRef = db.collection('citas');
                const snapshot = await citasRef
                    .where('fecha', '==', fecha)
                    .where('hora', '==', hora)
                    .where('estado', '!=', 'cancelada')
                    .get();
                
                return snapshot.empty;
            } catch (error) {
                console.error('Error al verificar disponibilidad:', error);
                return false;
            }
        }

        // Función para mostrar notificación
        function mostrarNotificacion(mensaje) {
            mensajeNotificacion.textContent = mensaje;
            notificacion.classList.add('mostrar');
            setTimeout(() => {
                cerrarNotificacion();
            }, 5000);
        }

        function cerrarNotificacion() {
            notificacion.classList.remove('mostrar');
        }

        // Establecer fecha mínima como hoy
        const hoy = new Date();
        const fechaMinima = hoy.toISOString().split('T')[0];
        fechaInput.min = fechaMinima;

        // Verificar horas ocupadas al cargar la página si hay una fecha seleccionada
        if (fechaInput.value) {
            verificarHorasOcupadas(fechaInput.value);
        }
    </script>
</body>
</html> 